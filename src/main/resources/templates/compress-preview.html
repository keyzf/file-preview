<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layouts/main">
<head>
    <!-- https://github.com/Stuk/jszip -->
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link type="text/css" rel="stylesheet" href="/js/ztree/css/metroStyle/metroStyle.css"/>
    <title>文件预览</title>
</head>
<body>
<div align="center">
    <div id="compress_viewer" class="ztree" th:data-fileurl="${fileUrl}"></div>
</div>
<script type="text/javascript" src="/js/jquery.min-1.10.2.js"></script>
<script type="text/javascript" src="/js/ztree/js/jquery.ztree.all.js"></script>
<script type="text/javascript" src="/js/jszip.js"></script>
<script type="text/javascript">
    $(function() {
        var fileUrl = $("#compress_viewer").data("fileurl");

        fetch(fileUrl)
            .then(function (response) {
                if (response.status === 200 || response.status === 0) {
                    return Promise.resolve(response.blob());
                } else {
                    return Promise.reject(new Error(response.statusText));
                }
            })
            .then(JSZip.loadAsync)
            .then(function (zip) {
                // 对象下的所有属性元素转成数组
                var files = Object.entries(zip.files);
                // 按照文件名称排序
                files = files.sort(function(a, b){
                    return a[0].localeCompare(b[0]);
                });

                var nodes = [];
                for(var i = 0; i < files.length; i++){
                    var file = files[i];
                    var node;
                    if(file[1].dir) {
                        node = {
                            "name": file[0],
                            "children": [],
                            "isParent": true
                        };
                    } else {
                        node = {
                            "name": file[0]
                        };
                    }
                    nodes.push(node);
                }
                // 构造文件目录树
                initZTree("compress_viewer", nodes);
            });

        // 初始化文件目录树
        function initZTree(id, zTreeNodes) {
             var settings = {
                data: {
                    simpleData: {
                        enable: true,
                        idKey: "id",
                        pIdKey: "parentId",
                        rootPId: -1
                    }
                },
                check:{
                    enable:true,
                    nocheckInherit:true
                 }
             };

            zTreeObj = $.fn.zTree.init($("#" + id), settings, zTreeNodes);
            zTreeObj.expandAll(true);
        }
    });
</script>
</body>
</html>